<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>לוח הכפל - עם מד התקדמות</title>
    <style>
        body { 
            font-family: system-ui, sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            background-color: #f0f9ff; margin: 0; padding: 10px;
            touch-action: manipulation;
        }
        .header-title { font-size: 1.4rem; font-weight: bold; color: #075985; margin: 10px 0; }
        .stats { 
            display: flex; gap: 15px; margin-bottom: 5px; 
            font-size: 0.9rem; background: white; padding: 12px; 
            border-radius: 12px 12px 0 0; width: 100%; max-width: 376px;
            box-sizing: border-box;
        }
        /* עיצוב מד ההתקדמות */
        .progress-container {
            width: 100%; max-width: 376px; height: 10px; background: #e2e8f0;
            border-radius: 0 0 12px 12px; margin-bottom: 15px; overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        #progressBar {
            height: 100%; width: 0%; background: #22c55e;
            transition: width 0.3s ease;
        }

        table { border-collapse: collapse; background: white; width: 100%; max-width: 400px; table-layout: fixed; border-radius: 8px; overflow: hidden; }
        td { border: 1px solid #e2e8f0; font-size: 0.8rem; height: 38px; text-align: center; padding: 0; }
        .header { background-color: #0284c7; color: white; font-weight: bold; }
        
        input { 
            width: 100%; height: 100%; text-align: center; font-size: 1rem; 
            border: none; outline: none; background: #f8fafc; border-radius: 0; padding: 0;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        input.correct { background-color: #22c55e !important; color: white; font-weight: bold; }
        input.wrong { background-color: #ef4444 !important; color: white; }
        
        #currentErrors { color: #ef4444; font-weight: bold; }
        
        #msgOverlay {
            display: none; position: fixed; top: 20%; background: #0284c7;
            color: white; padding: 20px 40px; border-radius: 50px;
            font-size: 1.5rem; font-weight: bold; z-index: 1000; animation: bounce 0.5s;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

    <div id="msgOverlay">מעולה! עוברים שלב...</div>

    <div class="header-title">שלב: <span id="levelDisp">1</span></div>
    
    <div class="stats">
        <div>חוסרים: <span id="holesDisp">2</span></div>
        <div>פסילות: <span id="failsDisp">0</span>/3</div>
        <div>טעויות: <span id="currentErrors">0</span></div>
    </div>
    <div class="progress-container">
        <div id="progressBar"></div>
    </div>

    <div id="table-container"></div>

    <script>
        let currentLevel = 1;
        let holesPerRow = 2;
        let totalFails = 0;
        let errorsInCurrentBoard = 0;
        let remainingInBoard = 0;
        let initialHolesCount = 0;

        function initGame() {
            errorsInCurrentBoard = 0;
            remainingInBoard = 0;
            document.getElementById('levelDisp').innerText = currentLevel;
            document.getElementById('holesDisp').innerText = holesPerRow;
            document.getElementById('failsDisp').innerText = totalFails;
            document.getElementById('currentErrors').innerText = 0;
            updateProgress();
            createTable();
        }

        function updateProgress() {
            const bar = document.getElementById('progressBar');
            if (initialHolesCount === 0) {
                bar.style.width = "0%";
            } else {
                const filled = initialHolesCount - remainingInBoard;
                const percent = (filled / initialHolesCount) * 100;
                bar.style.width = percent + "%";
            }
        }

        function createTable() {
            const container = document.getElementById('table-container');
            let html = '<table><tr><td class="header">X</td>';
            for (let i = 1; i <= 10; i++) html += `<td class="header">${i}</td>`;
            html += '</tr>';

            let inputIndex = 0;
            remainingInBoard = 0;

            for (let r = 1; r <= 10; r++) {
                html += `<tr><td class="header">${r}</td>`;
                let holeIndices = [];
                while(holeIndices.length < holesPerRow) {
                    let rand = Math.floor(Math.random() * 10) + 1;
                    if(!holeIndices.includes(rand)) holeIndices.push(rand);
                }

                for (let c = 1; c <= 10; c++) {
                    const ans = r * c;
                    if (holeIndices.includes(c)) {
                        html += `<td><input type="number" inputmode="numeric" id="input_${inputIndex}" data-ans="${ans}" oninput="check(this, ${inputIndex})"></td>`;
                        remainingInBoard++;
                        inputIndex++;
                    } else {
                        html += `<td>${ans}</td>`;
                    }
                }
                html += '</tr>';
            }
            initialHolesCount = remainingInBoard; // שמירת כמות החורים ההתחלתית למד ההתקדמות
            container.innerHTML = html + '</table>';
            updateProgress();
            setTimeout(() => { if(document.getElementById('input_0')) document.getElementById('input_0').focus(); }, 300);
        }

        function check(el, index) {
            const val = el.value;
            const ans = el.getAttribute('data-ans');

            if (val === ans) {
                el.classList.add('correct');
                el.classList.remove('wrong');
                el.disabled = true;
                remainingInBoard--;
                updateProgress();
                
                let nextIndex = index + 1;
                let nextInput = document.getElementById(`input_${nextIndex}`);
                if (nextInput) nextInput.focus();

                if (remainingInBoard === 0) {
                    processBoardEnd();
                }
            } else {
                if (val.length >= ans.length) {
                    el.classList.add('wrong');
                    errorsInCurrentBoard++;
                    document.getElementById('currentErrors').innerText = errorsInCurrentBoard;
                    setTimeout(() => {
                        el.value = '';
                        el.classList.remove('wrong');
                    }, 500);
                }
            }
        }

        function processBoardEnd() {
            const overlay = document.getElementById('msgOverlay');
            
            if (errorsInCurrentBoard > 10) {
                totalFails++;
                if (totalFails >= 3) {
                    overlay.innerText = "3 פסילות - חוזרים להתחלה";
                    overlay.style.background = "#ef4444";
                    currentLevel = 1; holesPerRow = 2; totalFails = 0;
                } else {
                    overlay.innerText = `פסילה! ${errorsInCurrentBoard} טעויות`;
                    overlay.style.background = "#f59e0b";
                }
            } else {
                overlay.innerText = "כל הכבוד! שלב הבא...";
                overlay.style.background = "#22c55e";
                currentLevel++;
                if (holesPerRow < 10) holesPerRow++;
            }

            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.style.display = 'none';
                initGame();
            }, 2000);
        }

        initGame();
    </script>
</body>
</html>